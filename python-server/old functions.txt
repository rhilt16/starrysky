# Old functions


@app.get("/planets-cartesian")
def get_planets():
    t = ts.now()
    # Clear previous list
    celestial_bodies.clear()

    # For each planet, compute position and magnitude
    for name, body in targets.items():
        # Calculate position relative to the Sun
        x, y, z = (body.at(t) - sun.at(t)).position.au
        # Calculate magnitude as seen from Earth
        astrometric = earth.at(t).observe(body)
        # Compute the magnitude
        magnitude = float(planetary_magnitude(astrometric))
        # Add to the list
        celestial_bodies.append(
            CelestialBody(
                name,
                magnitude,
                [x, y, z]
            )
        )

    return jsonify([body.__dict__ for body in celestial_bodies])


@app.get("/stars-cartesian")
def get_stars(min_magnitude: float = 10.0, time: str = None):
    # Override with query parameters if provided
    if(request.args.get('time')):
        time = request.args.get('time')
    if(request.args.get('min_magnitude')):
        min_magnitude = float(request.args.get('min_magnitude'))
    
    t = None
    if(time):
        t = ts.from_datetime(time)
    else:
        t = ts.now()

    # Clear previous list
    celestial_bodies.clear()
    # Filter stars by magnitude
    stars_df = df[df['magnitude'] <= min_magnitude]

    # Iterate through stars and compute positions
    count = 0
    for hip_id, star_data in stars_df.iterrows():
        star = Star(ra_hours=star_data['ra_degrees'] / 15.0,
                    dec_degrees=star_data['dec_degrees'])
        
        
        astrometric = earth.at(t).observe(star)
        ra, dec, distance = astrometric.radec()

        # Convert to radians
        ra_rad = ra.radians
        dec_rad = dec.radians

        # Convert to Cartesian unit vector
        x = cos(dec_rad) * cos(ra_rad)
        y = cos(dec_rad) * sin(ra_rad)
        z = sin(dec_rad)
        celestial_bodies.append(
            CelestialBody(
                f"HIP {hip_id}",
                float(star_data['magnitude']),
                [x, y, z]
            )
        )
        count += 1

    return jsonify({"count": count, "stars": [body.__dict__ for body in celestial_bodies]})
